<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="stylesheet" href="{{ url_for('static', filename='home.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Alumni+Sans+Pinstripe:ital@0;1&family=Gugi&family=Momo+Trust+Display&family=Orbitron:wght@400..900&family=Roboto:ital,wght@0,100..900;1,100..900&family=Silkscreen:wght@400;700&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&family=Urbanist:ital,wght@0,100..900;1,100..900&family=VT323&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <title>결과 페이지</title>
</head>
<body>
  <!-- 내 정보 버튼 -->
  <div class="top-bar">
    <a href="{{ url_for('userInfo', user_id=user_id) }}">
      <img id="info" src="{{ url_for('static', filename='images/edit.png') }}" alt="정보수정" width="80px">
    </a>

    <!-- 뒤로가기 + 오늘의 추천 + 그래프 버튼 -->
    <a href="{{ url_for('recommend', user_id=user_id) }}">
      <img id="recommend" src="{{ url_for('static', filename='images/recommend.png') }}" alt="추천" width="80px">
    </a>

    <a href="{{ url_for('weight_graph', user_id=user_id) }}">
      <button class="graph-btn">weight graph</button>
    </a>

    <button class="back-btn" onclick="history.back()">뒤로가기</button>

  </div>

  <!-- 우측 상단 D-Day 표시 -->
  <div class="d-day-top">{{ d_day_text }}</div>

  <!-- 우측: 캐릭터 -->
  <div class="container">
    <div class="egg">

      <!-- 정보 표시 버튼 -->
      <button id="info-table-btn" class="info-btn"></button>

      <!-- 로고 -->
      <p id="logo">BodyBuddy</p>

      <!--캐릭터-->
      <div id="character-image">
        <img id="character-img" src="{{ character_img }}" alt="내 캐릭터" width="300px" height="300px">
      </div>

      <!-- 사용자 정보 표 -->
      <div id="user-info-table" style="display: none;">
        <h3>{{ user_info.name }}님의 정보</h3>
        <table class="user-info-table">
          <tr><th>성별</th><td>{{ user_info.gender }}</td></tr>
          <tr><th>나이</th><td>{{ user_info.age }} 세</td></tr>
          <tr><th>신장</th><td>{{ user_info.height }} cm</td></tr>
          <tr><th>체중</th><td id="weight">{{ user_info.weight }} kg</td></tr>
          <tr><th>체지방률</th><td>{{ user_info.body_fat }} %</td></tr>
          <tr><th>BMI</th><td>{{ bmi }}</td></tr>
          <tr><th>BMR</th><td>{{ bmr }}</td></tr>
        </table>
      </div>

      <!-- 체중 증감 버튼 -->
      <div class="weight-control">
        <button type="button" onclick="updateWeight('minus')">-</button>
        <span id="weight-display" onclick="enableEdit()">{{ weight }} kg</span>
        <button type="button" onclick="updateWeight('plus')">+</button>
      </div>
    </div>

  <!-- 자동 멘트 -->
    <div class="comment" id="comment">{{ comment }}</div>
  </div>

  <!-- D-Day 알람 메시지 -->
  {% if alarm_message %}
  <div class="alarm">{{ alarm_message }}</div>
  {% endif %}

  
  

  <!-- JS: AJAX 요청 -->
  <script>
    function updateWeight(action) {
      const currentWeight = document.getElementById("weight-display").innerText.split(" ")[0];
      fetch("/update_weight", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `user_id={{ user_id }}&weight=${currentWeight}&action=${action}`
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById("weight-display").innerText = data.weight + " kg";
        document.getElementById("weight").innerText = data.weight;
        document.getElementById("comment").innerText = data.comment;
        document.getElementById("character-img").src = data.character_img;
      })
      .catch(error => {
        console.error('Error:', error);
        alert('체중 업데이트 중 오류가 발생했습니다.');
      });
    }

    function enableEdit() {
      const span = document.getElementById("weight-display");
      const currentValue = span.innerText.replace(" kg", "");
      const input = document.createElement("input");
      input.type = "number";
      input.step = "0.1";
      input.value = currentValue;
      input.id = "weight-input";
      input.style.width = "100px";
      input.style.fontSize = "28px";
      input.style.fontWeight = "bold";
      input.style.textAlign = "center";

      span.replaceWith(input);
      input.focus();

      input.addEventListener("blur", () => saveWeight(input.value));
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          saveWeight(input.value);
        }
      });
    }

    function saveWeight(newWeight) {
      fetch("/update_weight", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `user_id={{ user_id }}&weight=${newWeight}&action=set`
      })
      .then(response => response.json())
      .then(data => {
        const input = document.getElementById("weight-input");
        const span = document.createElement("span");
        span.id = "weight-display";
        span.innerText = data.weight + " kg";
        span.onclick = enableEdit;
        input.replaceWith(span);

        updateDisplay(data.weight, data.comment, data.character_img);
      })
      .catch(error => {
        console.error('Error:', error);
        alert('체중 저장 중 오류가 발생했습니다.');
      });
    }

    function updateDisplay(weight, comment, character_img) {
      document.getElementById("weight").innerText = weight;
      document.getElementById("comment").innerText = comment;
      document.getElementById("character-img").src = character_img;
    }

    document.getElementById("info-table-btn").addEventListener("click", function() {
      const img = document.getElementById("character-image");
      const info = document.getElementById("user-info-table");

      if (info.style.display === "none") {
          info.style.display = "block";
          img.style.display = "none";
      } else {
          info.style.display = "none";
          img.style.display = "block";
      }

    });
  </script>
</body>
</html>
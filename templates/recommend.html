<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì‹ë‹¨í‘œë¥¼ ì§œë³´ì•„ìš”</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='recommend.css') }}">
</head>

<body>

  <!-- ì „ì²´ í˜ì´ì§€ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ -->
  <div class="meal-wrapper">
    <h1 class="title-with-images">
      <img src="{{ url_for('static', filename='images/ganadi_Pic.png') }}" class="title-img left-img">
      <p>! {{ user_name }}ë‹˜ì˜ ì‹ë‹¨í‘œ !</p>
      <img src="{{ url_for('static', filename='images/gonyani_Pic.png') }}" class="title-img right-img">
    </h1>

    <p class="subtitle">ì™¼ìª½ì˜ ìŒì‹ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì˜¤ëŠ˜ ë¨¹ì„ ìŒì‹ì„ ì˜¤ë¥¸ìª½ì˜ ì‹ë‹¨í‘œì— ê°€ì ¸ì™€ì„œ ìŠ¤ìŠ¤ë¡œ ì‹ë‹¨í‘œë¥¼ ë§Œë“¤ì–´ë´ ~<br>
      ê¶Œì¥ ì¹¼ë¡œë¦¬: <strong>{{ recommended_calories }} kcal</strong></p>

    <div class="container">

      <!-- ===============================
           ì™¼ìª½ ìŒì‹ ë¦¬ìŠ¤íŠ¸
      ================================ -->
      <div class="food-list">
        <h3>ğŸ™ ìŒì‹ ë¦¬ìŠ¤íŠ¸</h3>
        <p>ìŒì‹ ê²€ìƒ‰í•˜ê¸°</p>

        <input
          type="text"
          id="searchFood"
          placeholder="ì˜¤ëŠ˜ì€ ì–´ë–¤ ê±¸ ë¨¹ì„ê±°ì•¼?"
          onkeyup="filterFoods()"
          class="search-input"
        >

        <div id="foodContainer">
          {% for category, items in foods.items() %}
            <h4 class="category-title">{{ category }}</h4>

            {% for food, cal in items.items() %}
              <div class="food-item"
                   draggable="true"
                   data-food="{{ food }}"
                   data-cal="{{ cal }}">
                {{ food }} ({{ cal }} kcal)
              </div>
            {% endfor %}
          {% endfor %}
        </div>
      </div>


      <!-- ===============================
           ì˜¤ë¥¸ìª½ ì‹ë‹¨ ë“œë¡­ì¡´
      ================================ -->
      <div class="meal-area">

        <div class="meal-box" ondragover="allowDrop(event)" ondrop="dropFood(event, 'breakfast')">
          <h3>ì•„ì¹¨ ğŸ</h3>
          <div id="breakfast"></div>
        </div>

        <div class="meal-box" ondragover="allowDrop(event)" ondrop="dropFood(event, 'lunch')">
          <h3>ì ì‹¬ ğŸ¥—</h3>
          <div id="lunch"></div>
        </div>

        <div class="meal-box" ondragover="allowDrop(event)" ondrop="dropFood(event, 'dinner')">
          <h3>ì €ë… ğŸš</h3>
          <div id="dinner"></div>
        </div>

        <div class="meal-box" ondragover="allowDrop(event)" ondrop="dropFood(event, 'snack')">
          <h3>ê°„ì‹ ğŸª</h3>
          <div id="snack"></div>
        </div>

        <p id="total-cal" class="total-calorie">ì´ ì„­ì·¨ ì˜ˆì • ì¹¼ë¡œë¦¬: 0 kcal</p>
        <p id="calorie-message" class="calorie-message"></p>

      </div>
    </div>

    <button class="back-btn" onclick="history.back()">ë’¤ë¡œê°€ê¸°</button>

  </div> <!-- meal-wrapper END -->


  <!-- ===============================
       JavaScript
  ================================ -->
  <script>
    let draggedFood = null;

    /* ------------------------------
       ë“œë˜ê·¸ ì‹œì‘
    ------------------------------ */
    document.querySelectorAll(".food-item").forEach(item => {
      item.addEventListener("dragstart", e => {
        draggedFood = {
          name: e.target.dataset.food,
          cal: parseInt(e.target.dataset.cal)
        };
      });
    });

    function allowDrop(event) {
      event.preventDefault();
    }

    /* ------------------------------
       ìŒì‹ ë“œë¡­ ì²˜ë¦¬
    ------------------------------ */
    function dropFood(event, mealType) {
      event.preventDefault();
      if (!draggedFood) return;

      const target = document.getElementById(mealType);
      const div = document.createElement("div");
      div.classList.add("dropped-item");

      div.innerHTML = `
        <span>${draggedFood.name} (${draggedFood.cal} kcal)</span>
        <button class="delete-btn" onclick="deleteFood(this)">X</button>
      `;

      target.appendChild(div);
      updateTotalCalories();
      saveMeals();  
    }

    /* ------------------------------
       ìŒì‹ ì‚­ì œ
    ------------------------------ */
    function deleteFood(btn) {
      btn.parentElement.remove();
      updateTotalCalories();
      saveMeals();  
    }

    /* ------------------------------
       ì „ì²´ ì¹¼ë¡œë¦¬ ê³„ì‚°
    ------------------------------ */
    function updateTotalCalories() {
      let total = 0;

      ["breakfast", "lunch", "dinner", "snack"].forEach(meal => {
        const items = document.getElementById(meal).children;
        for (let item of items) {
          const cal = parseInt(item.textContent.match(/\((\d+) kcal\)/)[1]);
          total += cal;
        }
      });

      const recommended = {{ recommended_calories }};
      const totalEl = document.getElementById("total-cal");
      const msgEl = document.getElementById("calorie-message");

      totalEl.textContent = `ì´ ì„­ì·¨ ì˜ˆì • ì¹¼ë¡œë¦¬: ${total} kcal`;

      const diff = total - recommended;

      if (diff > 200) {
        msgEl.textContent = "âš  ê¶Œì¥ëŸ‰ë³´ë‹¤ ë„ˆë¬´ ë§ì´ ë¨¹ì—ˆì–´ìš”!";
        msgEl.style.color = "red";
      } else if (diff < -200) {
        msgEl.textContent = "âš  ë„ˆë¬´ ì ê²Œ ë¨¹ê³  ìˆì–´ìš”!";
        msgEl.style.color = "orange";
      } else {
        msgEl.textContent = "ğŸ‘Œ ì•„ì£¼ ì ì ˆí•œ ì‹ë‹¨ì´ì—ìš”!";
        msgEl.style.color = "green";
      }
    }

    /* ------------------------------
       â­ í•˜ë£¨ ë‹¨ìœ„ ì‹ë‹¨ ì €ì¥ ê¸°ëŠ¥
    ------------------------------ */

    function saveMeals() {
      const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD

      const meals = {
        date: today,
        breakfast: getMealItems("breakfast"),
        lunch: getMealItems("lunch"),
        dinner: getMealItems("dinner"),
        snack: getMealItems("snack"),
      };

      localStorage.setItem("bodybuddy_meals", JSON.stringify(meals));
    }

    // ê°œë³„ ì‹ë‹¨ì˜ ìŒì‹ ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
    function getMealItems(mealId) {
      const items = document.getElementById(mealId).children;
      const list = [];

      for (let item of items) {
        const match = item.textContent.match(/(.+?) \((\d+) kcal\)/);
        if (match) {
          list.push({
            name: match[1].trim(),
            cal: parseInt(match[2])
          });
        }
      }
      return list;
    }

    /* ------------------------------
      ì €ì¥ëœ ì‹ë‹¨ ë¶ˆëŸ¬ì˜¤ê¸°
    ------------------------------ */
    function loadMeals() {
      const data = localStorage.getItem("bodybuddy_meals");
      if (!data) return;

      const saved = JSON.parse(data);
      const today = new Date().toISOString().split("T")[0];

      // ë‚ ì§œ ë‹¤ë¥´ë©´ ì´ˆê¸°í™”
      if (saved.date !== today) {
        localStorage.removeItem("bodybuddy_meals");
        return;
      }

      // ë³µêµ¬
      restoreMeal("breakfast", saved.breakfast);
      restoreMeal("lunch", saved.lunch);
      restoreMeal("dinner", saved.dinner);
      restoreMeal("snack", saved.snack);

      updateTotalCalories();
    }

    function restoreMeal(mealId, items) {
      const target = document.getElementById(mealId);
      target.innerHTML = "";

      items.forEach(item => {
        const div = document.createElement("div");
        div.classList.add("dropped-item");

        div.innerHTML = `
          <span>${item.name} (${item.cal} kcal)</span>
          <button class="delete-btn" onclick="deleteFood(this)">X</button>
        `;

        target.appendChild(div);
      });
    }

    /* ------------------------------
       í˜ì´ì§€ ì—´ë¦´ ë•Œ ìë™ ë³µêµ¬
    ------------------------------ */
    window.onload = () => {
      loadMeals();
    };

    /* ------------------------------
       ìŒì‹ ê²€ìƒ‰ ê¸°ëŠ¥
    ------------------------------ */
    function filterFoods() {
      const search = document.getElementById("searchFood").value.toLowerCase();
      const items = document.querySelectorAll("#foodContainer .food-item");
      const categories = document.querySelectorAll("#foodContainer .category-title");

      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(search) ? "" : "none";
      });

      categories.forEach(category => {
        let next = category.nextElementSibling;
        let visible = false;

        while (next && next.classList.contains("food-item")) {
          if (next.style.display !== "none") {
            visible = true;
            break;
          }
          next = next.nextElementSibling;
        }

        category.style.display = visible ? "" : "none";
      });
    }
  </script>

</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì‹ë‹¨í‘œë¥¼ ì§œë³´ì•„ìš”</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='recommend.css') }}">
</head>

<body>

  <h2 class="title">{{ user_name }}ë‹˜ì˜ ì‹ë‹¨ êµ¬ì„±í•˜ê¸° ğŸ±</h2>
  <p class="subtitle">ê¶Œì¥ ì¹¼ë¡œë¦¬: <strong>{{ recommended_calories }} kcal</strong></p>

  <div class="container">

    <!-- ===============================
         ì™¼ìª½ ìŒì‹ ë¦¬ìŠ¤íŠ¸ (ì¹´í…Œê³ ë¦¬ + ê²€ìƒ‰ ê°€ëŠ¥)
    ================================ -->
    <div class="food-list">

      <h3>ğŸ™ ìŒì‹ ë¦¬ìŠ¤íŠ¸</h3>

      <!-- ê²€ìƒ‰ì°½ -->
      <input
        type="text"
        id="searchFood"
        placeholder="ìŒì‹ ê²€ìƒ‰..."
        onkeyup="filterFoods()"
        class="search-input"
      >

      <!-- ì¹´í…Œê³ ë¦¬ë³„ ìŒì‹ ëª©ë¡ -->
      <div id="foodContainer">
        {% for category, items in foods.items() %}
          <h4 class="category-title">{{ category }}</h4>

          {% for food, cal in items.items() %}
            <div class="food-item"
                 draggable="true"
                 data-food="{{ food }}"
                 data-cal="{{ cal }}">
              {{ food }} ({{ cal }} kcal)
            </div>
          {% endfor %}
        {% endfor %}
      </div>
    </div>


    <!-- ===============================
         ì˜¤ë¥¸ìª½ ì‹ë‹¨ ë“œë¡­ì¡´
    ================================ -->
    <div class="meal-area">

      <div class="meal-box" ondragover="allowDrop(event)" ondrop="dropFood(event, 'breakfast')">
        <h3>ì•„ì¹¨ ğŸ</h3>
        <div id="breakfast"></div>
      </div>

      <div class="meal-box" ondragover="allowDrop(event)" ondrop="dropFood(event, 'lunch')">
        <h3>ì ì‹¬ ğŸ¥—</h3>
        <div id="lunch"></div>
      </div>

      <div class="meal-box" ondragover="allowDrop(event)" ondrop="dropFood(event, 'dinner')">
        <h3>ì €ë… ğŸš</h3>
        <div id="dinner"></div>
      </div>

      <div class="meal-box" ondragover="allowDrop(event)" ondrop="dropFood(event, 'snack')">
        <h3>ê°„ì‹ ğŸª</h3>
        <div id="snack"></div>
      </div>

      <p id="total-cal" class="total-calorie">ì´ ì„­ì·¨ ì˜ˆì • ì¹¼ë¡œë¦¬: 0 kcal</p>
      <p id="calorie-message" class="calorie-message"></p>

    </div>
  </div>

  <button class="back-btn" onclick="history.back()">ë’¤ë¡œê°€ê¸°</button>


  <!-- ===============================
       JavaScript
  ================================ -->
  <script>
    let draggedFood = null;

    // ë“œë˜ê·¸ ì‹œì‘
    document.querySelectorAll(".food-item").forEach(item => {
      item.addEventListener("dragstart", e => {
        draggedFood = {
          name: e.target.dataset.food,
          cal: parseInt(e.target.dataset.cal)
        };
      });
    });

    // ë“œë í—ˆìš©
    function allowDrop(event) {
      event.preventDefault();
    }

    // ë“œë ì²˜ë¦¬ + ì‚­ì œ ë²„íŠ¼ ê¸°ëŠ¥ í¬í•¨
    function dropFood(event, mealType) {
      event.preventDefault();
      if (!draggedFood) return;

      const target = document.getElementById(mealType);
      const div = document.createElement("div");
      div.classList.add("dropped-item");

      div.innerHTML = `
        <span>${draggedFood.name} (${draggedFood.cal} kcal)</span>
        <button class="delete-btn" onclick="deleteFood(this)">X</button>
      `;

      target.appendChild(div);
      updateTotalCalories();
    }

    // ìŒì‹ ì‚­ì œ
    function deleteFood(btn) {
      btn.parentElement.remove();
      updateTotalCalories();
    }

    // ì „ì²´ ì¹¼ë¡œë¦¬ ê³„ì‚°
    function updateTotalCalories() {
      let total = 0;

      ["breakfast", "lunch", "dinner", "snack"].forEach(meal => {
        const items = document.getElementById(meal).children;
        for (let item of items) {
          const cal = parseInt(item.textContent.match(/\((\d+) kcal\)/)[1]);
          total += cal;
        }
      });

      const recommended = {{ recommended_calories }};
      const totalEl = document.getElementById("total-cal");
      const msgEl = document.getElementById("calorie-message");

      totalEl.textContent = `ì´ ì„­ì·¨ ì˜ˆì • ì¹¼ë¡œë¦¬: ${total} kcal`;

      const diff = total - recommended;

      if (diff > 200) {
        msgEl.textContent = "âš  ê¶Œì¥ëŸ‰ë³´ë‹¤ ë„ˆë¬´ ë§ì´ ë¨¹ì—ˆì–´ìš”!";
        msgEl.style.color = "red";
      } else if (diff < -200) {
        msgEl.textContent = "âš  ë„ˆë¬´ ì ê²Œ ë¨¹ê³  ìˆì–´ìš”!";
        msgEl.style.color = "orange";
      } else {
        msgEl.textContent = "ğŸ‘Œ ì•„ì£¼ ì ì ˆí•œ ì‹ë‹¨ì´ì—ìš”!";
        msgEl.style.color = "green";
      }
    }


    /* =============================
       ìŒì‹ ê²€ìƒ‰ ê¸°ëŠ¥
    ============================= */
    function filterFoods() {
      const search = document.getElementById("searchFood").value.toLowerCase();
      const items = document.querySelectorAll("#foodContainer .food-item");
      const categories = document.querySelectorAll("#foodContainer .category-title");

      // ìŒì‹ í•„í„°ë§
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(search) ? "" : "none";
      });

      // ì¹´í…Œê³ ë¦¬ ì œëª© í‘œì‹œ ì—¬ë¶€ ê²°ì •
      categories.forEach(category => {
        let next = category.nextElementSibling;
        let visible = false;

        while (next && next.classList.contains("food-item")) {
          if (next.style.display !== "none") {
            visible = true;
            break;
          }
          next = next.nextElementSibling;
        }

        category.style.display = visible ? "" : "none";
      });
    }
  </script>

</body>
</html>
